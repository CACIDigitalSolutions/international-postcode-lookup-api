
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>International Postcode Lookup API</title>
    <link href="content/styles.css" rel="stylesheet" />
    <script type="text/javascript" src="scripts/jquery-1.11.0.js"></script>
    <script type="text/javascript" src="scripts/jquery-ui-1.10.4.js"></script>
    <script type="text/javascript" src="scripts/jquery.autocomplete.js"></script>
    <script type="text/javascript" language="javascript">

        $(document).ready(function() {

            var countries = [];
            $.getJSON("http://localhost:3000/intl-postcode-api/countries", callbackFuncWithData);
            function callbackFuncWithData(data) {
                $.each(data, function(i, item) {
                    countries[i] = { value: item.b, data: item.a };
                });
            }

            $('#country').autocomplete({
                lookup: countries,
                transformResult: function(response) {
                    return {
                        suggestions: $.map(response, function(item) {
                            return { value: item.b, data: item.a };
                        })
                    };
                },
                onSelect: function (suggestion) {
                    $("#country").val(suggestion.value);
                    $("#countrycode").val(suggestion.data);
                    // added this ugliness to force a reload with the new values
                    location.reload();

                }
            });

            $('#postcode').autocomplete({
                serviceUrl: 'http://localhost:3000/intl-postcode-api/cities',
                minChars: 1,
                deferRequestBy: 250,
                dataType: 'json',
                paramName: 'postcode',
                cacheLength: 0,
                params: {country: $("#countrycode").val()},
                transformResult: function(response) {
                    return {
                        suggestions: $.map(response, function(item) {
                            return { value: item.c + " " + item.b, data: item.c + " " + item.b };
                        })
                    };
                },
                onSelect: function (suggestion) {
                    $("#postcode").val(suggestion.value);
                }
            });

            $('#city').autocomplete({
                serviceUrl: 'http://localhost:3000/intl-postcode-api/cities',
                minChars: 1,
                deferRequestBy: 250,
                dataType: 'json',
                paramName: 'city',
                params: {country: $("#countrycode").val()},
                transformResult: function(response) {
                    return {
                        suggestions: $.map(response, function(item) {
                            return { value: item.b + " " + item.c, data: item.b + " " + item.c };
                        })
                    };
                },
                onSelect: function (suggestion) {
                    $("#city").val(suggestion.value);
                }
            });

        });

   </script>

</head>
<body>

    <div class="container">
        <h1>International Postcode Lookup API</h1>
        <p>Country:</p>
        <div>
            <input type="text" name="country" id="country" />
            <input type="text" name="countrycode" id="countrycode" readonly />
        </div>
        <h2>Postcode Lookup</h2>
        <p>Postcode:</p>
        <div>
            <input type="text" name="postcode" id="postcode"/>
        </div>
        <h2>City Lookup</h2>
        <p>City:</p>
        <div>
            <input type="text" name="city" id="city"/>
        </div>

    </div>

</body>
</html>




